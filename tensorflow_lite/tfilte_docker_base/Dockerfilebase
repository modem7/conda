# syntax = docker/dockerfile:latest

FROM tensorflow/tensorflow:latest-devel as tflite-builder

ENV PIP_ROOT_USER_ACTION=ignore
ENV PYTHON_VER='python3.8'
ENV TENSORFLOWDIR='tensorflow_src/tensorflow/lite/tools/pip_package'
# Add a number below to limit the amount of cpu cores the build will use. If this value is blank, all cores will be used.
ENV NUM_JOBS=

RUN <<EOF
    set -x
    apt-get update
    apt-get install --no-install-recommends -y cmake
    python3 -m pip install -U pip
    python3 -m pip install -U pybind11 numpy Pillow
EOF

RUN BUILD_NUM_JOBS=$NUM_JOBS PYTHON=$PYTHON_VER $TENSORFLOWDIR/build_pip_package_with_cmake.sh native

FROM python:3.8-slim as pillow-simd-builder
ARG arch=x86_64

RUN <<EOF
    set -x
    apt-get update
    apt-get install --no-install-recommends -y \
        build-essential \
        cmake \
        ghostscript \
        git \
        libffi-dev \
        libfreetype6-dev \
        libfribidi-dev \
        libharfbuzz-dev \
        libjpeg-turbo-progs \
        libjpeg62-turbo-dev \
        liblcms2-dev \
        libopenjp2-7-dev \
        libsnappy-dev \
        libtiff5-dev \
        libwebp-dev \
        libxcb-icccm4 \
        libxcb-image0 \
        libxcb-keysyms1 \
        libxcb-render-util0 \
        libxkbcommon-x11-0 \
        netpbm \
        python3-dev \
        python3-numpy \
        python3-scipy \
        python3-setuptools \
        python3-tk \
        sudo \
        tcl8.6-dev \
        tk8.6-dev \
        virtualenv \
        wget \
        xvfb \
        zlib1g-dev

    python3 -m pip install --no-cache-dir -U pip
    
    python3 -m pip install --no-cache-dir -U \
        begins \
        cachetools \
        cython \
        irondomo \
        itsdangerous \
        psycopg2-binary \
        python-dateutil \
        python-snappy \
        pyzmq \
        redis \
        requests \
        sqlalchemy
    python3 -m pip uninstall -y pillow
    CC="cc -mavx2" pip wheel --no-cache-dir -w / \
        pillow-simd
    apt remove -y build-essential
    apt autoremove -y
    rm -rf /var/lib/apt/lists/*
EOF

FROM python:3.8-slim-buster

COPY --from=pillow-simd-builder /*.whl /

COPY --from=tflite-builder /tensorflow_src/tensorflow/lite/tools/pip_package/gen/tflite_pip/python/dist/tflite_runtime*.whl /

# Add additional required dependencies
# RUN <<EOF
    # set -x
    # apt-get update
    # apt-get install --no-install-recommends -y \
        # libjpeg-turbo-progs \
        # libopenjp2-7 \
        # libtiff5 \
        # libwebp6 \
        # libwebpdemux2 \
        # libwebpmux3 \
        # libxcb-icccm4 \
        # libxcb-image0 \
        # libxcb-keysyms1 \
        # libxcb-render-util0 \
        # libxkbcommon-x11-0 \
        # zlib1g
    # apt autoremove -y
    # rm -rf /var/lib/apt/lists/*
# EOF

RUN <<EOF
    set -x
    python3 -m pip install --no-cache-dir -U pip setuptools wheel
    python3 -m pip install --no-cache-dir -U numpy
    python3 -m pip install --no-cache-dir *.whl
    rm *.whl
EOF